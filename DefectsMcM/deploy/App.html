<!DOCTYPE html>
<html>
<head>
    <title>DefectsMcM</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var teams=["Blenders","Hue","Supernova"];this.start_date="2015-02-02",this.rows=[],this.loadDefects(teams,this.start_date)},loadDefects:function(teams,start_date){for(var defectsFilter=null,team=0;teams.length>team;team++){var tmp=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",operator:"=",value:teams[team]});defectsFilter=null===defectsFilter?tmp:defectsFilter.or(tmp)}Ext.create("Rally.data.wsapi.Store",{autoLoad:!0,model:"Defect",filters:defectsFilter,listeners:{load:function(store,data,success){console.log(data);for(var i=0;data.length>i;i++)console.log(data[i].Project.Name,data[i].ScheduleState)}},fetch:["FormattedID","Project","Parent","ScheduleState","Iteration","PlanEstimate","Deliverysatisfactionscore110","Teamstatus","TeamLifecycle","LPCVelocity","Release","ProductOwnerInvolvement15"]})},dataRow:function(program,team,sprint,lpcVelocity,plannedVelocity,actualVelocity,defectpoints,satisfaction){var row={program:program,team:team,sprint:sprint,lpcVelocity:lpcVelocity,plannedVelocity:plannedVelocity,actualVelocity:actualVelocity,defectsVelocity:defectpoints,targetUtilization:""+Math.round(100*plannedVelocity/lpcVelocity),velocityReliability:""+Math.round(100*actualVelocity/plannedVelocity),deliverySatisfaction:satisfaction};this.rows.push(row),this.store.load()},showTable:function(){var me=this;this.store=Ext.create("Rally.data.custom.Store",{fields:[{name:"date",type:"date"},{name:"team",type:"string"},{name:"sprint",type:"string"},{name:"lpcVelocity",type:"number"},{name:"plannedVelocity",type:"number"},{name:"actualVelocity",type:"number"},{name:"defectsVelocity",type:"number"},{name:"targetUtilization",type:"string"},{name:"velocityReliability",type:"string"},{name:"deliverySatisfaction",type:"number"}],data:this.rows}),this.grid=Ext.create("Rally.ui.grid.Grid",{store:this.store,columnCfgs:[{text:"Program",dataIndex:"program"},{text:"Team",dataIndex:"team"},{text:"Sprint",dataIndex:"sprint",flex:1.1},{text:"LPC Velocity",dataIndex:"lpcVelocity",align:"center",renderer:this.renderVelocityinput},{text:"Planned Velocity",dataIndex:"plannedVelocity",align:"center",renderer:this.renderVelocityinput},{text:"Actual Velocity",dataIndex:"actualVelocity",align:"center",renderer:this.renderVelocityinput},{text:"Defect Story points",dataIndex:"defectsVelocity",align:"center",renderer:this.renderVelocityinput},{text:"Target Utilization",dataIndex:"targetUtilization"},{text:"Velocity Reliability",dataIndex:"velocityReliability"},{text:"Delivery Satisfaction",dataIndex:"deliverySatisfaction",align:"center",renderer:this.renderVelocityinput}],listeners:{afterrender:function(grid){grid.setHeight(me.getHeight()-20)}}}),this.add(this.grid)},loadTeams:function(teams){for(var teamsFilter=null,team=0;teams.length>team;team++){var tmp=Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"=",value:teams[team]});teamsFilter=null===teamsFilter?tmp:teamsFilter.or(tmp)}var teamStore=Ext.create("Rally.data.wsapi.Store",{model:"Project",filters:teamsFilter,autoLoad:!0,listeners:{load:function(teamStore,teamData,success){this.loadSprints(teamData,this)},scope:this},fetch:["Name"]})},loadSprints:function(team_data,app){for(var sprintsFilter=null,team=0;team_data.length>team;team++){var tmp=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",operator:"=",value:team_data[team].data.Name});sprintsFilter=null===sprintsFilter?tmp:sprintsFilter.or(tmp)}var today=new Date;sprintsFilter=sprintsFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:today})),Ext.create("Rally.data.wsapi.Store",{autoLoad:!0,model:"Iteration",filters:sprintsFilter,sorters:[{property:"EndDate",direction:"DESC"}],listeners:{load:function(store,data,success){for(var items=[],storyFilter=null,t=0;team_data.length>t;t++)for(var program=team_data[t].data.Parent.Name,team=team_data[t].data.Name,j=0,s=0;data.length>s;s++)if(data[s].data.Project.Name==team){var tmpFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.ObjectID",operator:"=",value:data[s].data.ObjectID}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Parent.Name",operator:"Contains",value:"Iteration Reporting Parent"}).or(Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"=",value:"Accepted"}))).and(Ext.create("Rally.data.wsapi.Filter",{property:"DirectChildrenCount",operator:"=",value:"0"}));if(storyFilter=null===storyFilter?tmpFilter:storyFilter.or(tmpFilter),items.push({team:team_data[t].data,sprint:data[s].data,velocities:[data[s].data.PlannedVelocity,0,0,0]}),j++,j>=app.sprints_per_team)break}app.loadStories(storyFilter,items)},scope:app},fetch:["Name","Project","ObjectID","PlannedVelocity","StartDate","EndDate"]})},loadStories:function(filter,items){Ext.create("Rally.data.wsapi.Store",{autoLoad:!0,model:"HierarchicalRequirement",filters:filter,listeners:{load:function(store,data,success){for(var defectFilter=null,i=0;items.length>i;i++){for(var v=0;data.length>v;v++)data[v].data.Iteration._refObjectUUID==items[i].sprint._refObjectUUID&&(data[v].data.Parent&&null!==data[v].data.Parent&&data[v].data.Parent._refObjectName.indexOf("Iteration Reporting Parent")>-1?(items[i].velocities[1]=data[v].get("LPCVelocity"),items[i].sprint.satisfaction=data[v].get("Deliverysatisfactionscore110")):items[i].velocities[2]+=data[v].get("PlanEstimate"));var tmpFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.ObjectID",operator:"=",value:items[i].sprint.ObjectID}).and(Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"=",value:"Accepted"}));defectFilter=null===defectFilter?tmpFilter:defectFilter.or(tmpFilter)}this.loadDefects(defectFilter,items)},scope:this},fetch:["FormattedID","Parent","ScheduleState","Iteration","PlanEstimate","Deliverysatisfactionscore110","Teamstatus","TeamLifecycle","LPCVelocity","Release","ProductOwnerInvolvement15"]})}});

            Rally.launchApp('CustomApp', {
                name:"DefectsMcM",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
